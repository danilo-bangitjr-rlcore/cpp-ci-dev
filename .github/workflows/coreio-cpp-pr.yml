name: CoreIO-CPP Style and Tests
permissions: write-all # Needed to comment coverage% on PR

on:
  pull_request:
    paths:
      - "coreio-cpp/**"
      # Prevent triggering on other folders changes while cpp workflow is not ready
      # - "libs/**"
      # - "config/**"
  merge_group:
    paths:
      - "coreio-cpp/**"
      # Prevent triggering on other folders changes while cpp workflow is not ready
      # - "libs/**"
      # - "config/**"

concurrency:
  group: coreio-cpp-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------
  # -- Style --
  # -----------
  coreio-cpp-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: coreio-cpp
    steps:
      - uses: actions/checkout@v4
      # TODO: Enable ccache to speed up builds
      # - uses: hendrikmuhs/ccache-action@v1.2
      - name: Setup
        uses: ./.github/actions/setup
        with:
          subrepo: coreio-cpp
          language: cpp

      - name: set up path
        run: echo "$PWD/.venv/bin" >> $GITHUB_PATH

      # TODO: Integrate a C++ linter here
      # TODO: Choose best C++ linter for the project and configure it properly
      # linting
      # - uses: astral-sh/ruff-action@v1
      #   with:
      #       src: coreio-cpp

      # - uses: dciborow/action-pylint@0.1.0
      #   with:
      #     github_token: ${{ secrets.github_token }}
      #     reporter: github-pr-review
      #     level: warning
      #     workdir: coreio-cpp
      #     glob_pattern: "src/"

      # TODO: Delete before final PR. CPP is strongly typed so type checking is done at compile time.
      # type checking
      # - uses: jakebailey/pyright-action@v2
      #   with:
      #     pylance-version: latest-release
      #     working-directory: coreio-cpp

      - name: Build Debug & Run Tests
        run: |
          cmake --preset debug-linux
          cmake --build --preset debug-build
          ctest --preset run-tests --output-on-failure

      - name: Build & Generate Coverage Report
        run: |
          cmake --preset coverage
          cmake --build --preset coverage-build

      - name: Extract Coverage Percentage
        id: extract-coverage
        run: |
          COV_PERCENTAGE=$(grep "TOTAL" build/coverage/report/coverage.txt | awk '{print $NF}' | sed 's/%//')
          echo "Coverage Percentage: $COV_PERCENTAGE"
          echo "COV_PERCENTAGE=$COV_PERCENTAGE" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        id: code-coverage-upload-step
        with:
          name: code-coverage-report
          path: coreio-cpp/build/coverage/report/
          overwrite: true

      - run: |
          echo "ğŸ CoreIO-CPP tests ran with ${{ env.COV_PERCENTAGE }}% coverage ğŸ"
          echo "${{ steps.code-coverage-upload-step.outputs.artifact-url }}"

      # - uses: thollander/actions-comment-pull-request@v3
      #   with:
      #     message: |
      #       _(execution **${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_
      #       ğŸ CoreIO-CPP tests ran. Coverage reporting is not yet configured. ğŸ
      #     comment-tag: execution-coreio-cpp
