name: CoreIO-CPP Style and Tests
permissions: write-all # Needed to comment coverage% on PR

on:
  pull_request:
    paths:
      - "coreio-cpp/**"
      - "libs/**"
      - "config/**"
  merge_group:
    paths:
      - "coreio-cpp/**"
      - "libs/**"
      - "config/**"

concurrency:
  group: coreio-cpp-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------
  # -- Style --
  # -----------
  coreio-cpp-style-n-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: coreio-cpp
    steps:
      - uses: actions/checkout@v4
      # TODO: Enable ccache to speed up builds
      # - uses: hendrikmuhs/ccache-action@v1.2
      - name: Setup
        uses: ./.github/actions/setup
        with:
          subrepo: coreio-cpp

      - name: set up path
        run: echo "$PWD/.venv/bin" >> $GITHUB_PATH

      # TODO: Also lint CMakeLists.txt files using cmakelang

      - name: Run clang-format (style check)
        run: |
          find . -regex '.*\.\(cpp\|hpp\|cc\|cxx\|h\)' -not -path "./build/*" -exec clang-format --style=file -Werror -i {} \;
          git diff --exit-code

      - name: Run cppcheck (static analysis)
        run: |
          cppcheck --enable=warning,style,performance,portability \
                   --suppress=missingIncludeSystem \
                   --error-exitcode=1 \
                   --inline-suppr \
                   --quiet \
                   --language=c++ \
                   $(find . -name '*.cpp' -o -name '*.hpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.h' | grep -v "./build/")      

      - name: Configure & Build Debug
        run: |
          cmake --preset debug-linux
          cmake --build --preset debug-build

      - name: Run Tests
        run: |
          ctest --preset run-tests --output-on-failure

      - name: Generate Coverage Report
        run: |
          cmake --preset coverage
          cmake --build --preset coverage-build

      - name: Extract Coverage Percentage
        id: extract-coverage
        run: |
          COV_PERCENTAGE=$(grep "TOTAL" build/coverage/report/coverage.txt | awk '{print $NF}' | sed 's/%//')
          echo "Coverage Percentage: $COV_PERCENTAGE"
          echo "COV_PERCENTAGE=$COV_PERCENTAGE" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        id: code-coverage-upload-step
        with:
          name: code-coverage-report
          path: coreio-cpp/build/coverage/report/
          overwrite: true

      - run: |
          echo "ğŸ CoreIO-CPP tests ran with ${{ env.COV_PERCENTAGE }}% coverage ğŸ"
          echo "${{ steps.code-coverage-upload-step.outputs.artifact-url }}"

      - uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            _(execution **${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_
            ğŸ CoreIO-CPP tests ran with ${{ env.COV_PERCENTAGE }}% coverage ğŸ
            ${{ steps.code-coverage-upload-step.outputs.artifact-url }}
          comment-tag: execution-coreio-cpp
