name: CoreIO-CPP Style and Tests
permissions: write-all # Needed to comment coverage% on PR

on:
  pull_request:
    paths:
      - "coreio-cpp/**"
      # Prevent triggering on other folders changes while cpp workflow is not ready
      # - "libs/**"
      # - "config/**"
  merge_group:
    paths:
      - "coreio-cpp/**"
      # Prevent triggering on other folders changes while cpp workflow is not ready
      # - "libs/**"
      # - "config/**"

concurrency:
  group: coreio-cpp-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 1. Checkout + restore caches (produces artifacts for other jobs)
  # ------------------------------------------------------------------
  checkout-and-cache:
    name: Checkout & Cache
    runs-on: ubuntu-latest
    outputs:
      cache-ccache: ${{ steps.ccache.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0      # needed for clang-tidy diff mode

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          max-size: 1G

      # - name: Cache Conan packages
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.conan2
      #     key: conan-${{ runner.os }}-${{ hashFiles('conanfile.txt', 'conanfile.py') }}
      #     restore-keys: conan-${{ runner.os }}-

  # ------------------------------------------------------------------
  # 2. Fast required lane (must pass before merge)
  # ------------------------------------------------------------------
  build-and-test:
    needs: checkout-and-cache
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu GCC Debug + ASan
            os: ubuntu-latest
            compiler: gcc
            configure-preset: debug-linux
            build-preset: debug-build
            test-preset: run-tests
            # TODO: What do these flags do on GCC? Do we need them?
            # extra-cmake: -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer"
            required: true

          - name: Ubuntu GCC Release + ASan
            os: ubuntu-latest
            compiler: gcc
            configure-preset: release-linux
            build-preset: release-build
            test-preset: run-tests-release
            # TODO: What do these flags do on GCC? Do we need them?
            # extra-cmake: -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer"
            required: true

          # - name: Windows MSVC 2022
          #   os: windows-latest
          #   compiler: msvc
          #   build-type: RelWithDebInfo
          #   required: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup compiler (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          sudo apt update -y
          sudo apt-get install -y gcovr lcov cmake build-essential
          sudo apt-get install -y clang-format cppcheck
          echo "CC=${{ matrix.compiler == 'gcc' && 'gcc' }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.compiler == 'gcc' && 'g++' }}" >> $GITHUB_ENV

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2

      - name: Install dependencies (Conan)
        run: |
          pip install conan
          conan profile detect --force
          conan install . --output-folder=build --build=missing -s build_type=${{ matrix.build-type }}

      - name: Configure CMake
        run: cmake --preset ${{ matrix.configure-preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.build-preset }}

      - name: Test
        run: ctest --preset ${{ matrix.test-preset }} --output-on-failure

  # # ------------------------------------------------------------------
  # # 3. Formatting (fail fast)
  # # ------------------------------------------------------------------
  # format:
  #   needs: checkout-and-cache
  #   name: clang-format
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Run clang-format check
  #       uses: jidicula/clang-format-action@v4.13.0
  #       with:
  #         clang-format-version: 19
  #         fallback-style: Google
  #         exclude-regex: '^third_party/|^build/'

  # # ------------------------------------------------------------------
  # # 4. clang-tidy (best-effort, runs only on changed files â†’ super fast)
  # # ------------------------------------------------------------------
  # clang-tidy:
  #   needs: checkout-and-cache
  #   name: clang-tidy
  #   runs-on: ubuntu-latest
  #   continue-on-error: true   # change to false if you want to block merges
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup clang-tidy
  #       run: sudo apt install -y clang-tidy-19

  #     - name: Install dependencies
  #       run: |
  #         pip install conan
  #         conan profile detect --force
  #         conan install . --output-folder=build --build=missing -s build_type=Debug

  #     - name: Run clang-tidy on changed files
  #       run: |
  #         git fetch origin ${{ github.base_ref }} --depth=1
  #         CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.sha }} | grep -E '\.(cpp|hpp|cxx|hxx)$' || true)
  #         if [ -z "$CHANGED_FILES" ]; then
  #           echo "No C++ files changed"
  #           exit 0
  #         fi
  #         cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
  #         run-clang-tidy-19 -quiet -p build $CHANGED_FILES || echo "clang-tidy found issues (non-blocking)"

  # # ------------------------------------------------------------------
  # # 5. Optional heavy jobs (run nightly or on main only)
  # # ------------------------------------------------------------------
  # static-analysis:
  #   if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
  #   name: CodeQL + cppcheck
  #   runs-on: ubuntu-latest
  #   permissions:
  #     security-events: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: cpp
  #     - name: Build (for CodeQL)
  #       run: |
  #         cmake -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #         cmake --build build
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3

  #     - name: cppcheck
  #       run: |
  #         sudo apt install -y cppcheck
  #         cppcheck --enable=all --inconclusive --suppress=missingIncludeSystem --inline-suppr src/ include/ 2> cppcheck-report.txt
  #         cat cppcheck-report.txt


  # # -----------
  # # -- Style --
  # # -----------
  # coreio-cpp-ci:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: coreio-cpp
  #   steps:
  #     - uses: actions/checkout@v4
  #     # TODO: Enable ccache to speed up builds
  #     # - uses: hendrikmuhs/ccache-action@v1.2
  #     - name: Setup
  #       uses: ./.github/actions/setup
  #       with:
  #         subrepo: coreio-cpp
  #         language: cpp

  #     - name: set up path
  #       run: echo "$PWD/.venv/bin" >> $GITHUB_PATH

  #     - name: Lint CMake files
  #       run: |
  #         find . -name "CMakeLists.txt" -not -path "./build/*" -o -name "*.cmake" -not -path "./build/*" | xargs cmake-lint

  #     - name: Check Source File Styles with clang-format
  #       run: |
  #         find . -regex '.*\.\(cpp\|hpp\|cc\|cxx\|h\)' -not -path "./build/*" -exec clang-format --style=file -Werror -i {} \;
  #         git diff --exit-code

  #     - name: Static Analysis with cppcheck
  #       run: |
  #         cppcheck --enable=warning,style,performance,portability \
  #                  --suppress=missingIncludeSystem \
  #                  --error-exitcode=1 \
  #                  --inline-suppr \
  #                  --quiet \
  #                  --language=c++ \
  #                  --std=c++20 \
  #                  $(find . -name '*.cpp' -o -name '*.hpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.h' | grep -v "./build/")      

  #     - name: Configure & Build Debug
  #       run: |
  #         cmake --preset debug-linux
  #         cmake --build --preset debug-build

  #     - name: Run Tests (Debug)
  #       run: |
  #         ctest --preset run-tests --output-on-failure

  #     - name: Configure & Build Release
  #       run: |
  #         cmake --preset release-linux
  #         cmake --build --preset release-build

  #     - name: Run Tests (Release)
  #       run: |
  #         ctest --preset run-tests-release --output-on-failure

  #     - name: Generate Coverage Report
  #       run: |
  #         cmake --preset coverage
  #         cmake --build --preset coverage-build
  #         COV_PERCENTAGE=$(grep "TOTAL" build/coverage/report/coverage.txt | awk '{print $NF}' | sed 's/%//')
  #         echo "Coverage Percentage: $COV_PERCENTAGE"
  #         echo "COV_PERCENTAGE=$COV_PERCENTAGE" >> $GITHUB_ENV

  #     - uses: actions/upload-artifact@v4
  #       id: code-coverage-upload-step
  #       with:
  #         name: code-coverage-report
  #         path: coreio-cpp/build/coverage/report/
  #         overwrite: true

  #     - run: |
  #         echo "ğŸ CoreIO-CPP tests ran with ${{ env.COV_PERCENTAGE }}% coverage ğŸ"
  #         echo "${{ steps.code-coverage-upload-step.outputs.artifact-url }}"

  #     - uses: thollander/actions-comment-pull-request@v3
  #       with:
  #         message: |
  #           _(execution **${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_
  #           ğŸ CoreIO-CPP tests ran with ${{ env.COV_PERCENTAGE }}% coverage ğŸ
  #           ${{ steps.code-coverage-upload-step.outputs.artifact-url }}
  #         comment-tag: execution-coreio-cpp
