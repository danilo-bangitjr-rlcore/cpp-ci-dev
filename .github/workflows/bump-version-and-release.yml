name: Bump Version on Push to Master

permissions:
  contents: write

on:
  push:
    branches:
      - master

jobs:
  bump-version:
    if: ${{ !startsWith(github.event.head_commit.message, 'bump:') }}
    runs-on: ubuntu-latest
    name: Bump version and create changelog with commitizen

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - id: cz
      name: Create bump and changelog
      uses: commitizen-tools/commitizen-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        changelog_increment_filename: body.md

    # Commitizen stores previous version as PREVIOUS_VERSION
    # and post-bump version as REVISION within the environment
    # If these are equal, we should skip subsequent steps
    # related to Github releases and asset generation
    - if: ${{ env.PREVIOUS_REVISION != env.REVISION }}
      name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "requirements**.txt"

    - if: ${{ env.PREVIOUS_REVISION != env.REVISION }}
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.PRIVATE_DEPLOY_KEY }}

    - if: ${{ env.PREVIOUS_REVISION != env.REVISION }}
      run: |
        uv venv
        uv pip compile --extra=dev pyproject.toml -o deps.txt
        uv pip sync deps.txt
        uv build

    # Github's Release action is deprecated, so instead we call the release API directly
    # https://docs.github.com/en/rest/releases/releases?apiVersion=2022-11-28
    - if: ${{ env.PREVIOUS_REVISION != env.REVISION }}
      name: Create Release on GitHub
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        jq -n \
          --arg name "Release v${{ steps.cz.outputs.version }}" \
          --arg tag_name "v${{ steps.cz.outputs.version }}" \
          --rawfile body body.md \
          '$ARGS.named' > release_body.json
        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          -d @release_body.json \
          https://api.github.com/repos/${{ github.repository }}/releases > release.json

    - if: ${{ env.PREVIOUS_REVISION != env.REVISION }}
      name: Upload Assets to Release
      id: upload_assets_to_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        upload_url=$(jq -r '.upload_url' release.json | sed 's/{?name,label}//')
        for file in ./dist/*; do
          filename=$(basename "$file")
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$file" \
            "$upload_url?name=$filename"
        done
